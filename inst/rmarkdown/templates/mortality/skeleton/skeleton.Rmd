---
title: "Mortality survey"
output: word_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      error = TRUE)
library(dplyr)
library(knitr)
library(sitrep)
library(survey) # for survey functions 
library(srvyr) # dplyr wrapper for survey
library(ggplot2)
```

```{r read_data, message = FALSE}
# use read_data stuff from outbreak?


## Read data ------------------------------------
# CSV file
# linelist_raw <- rio::import("linelist.csv")
#
# Excel file
# to read in a specific sheet use "which"
# linelist_raw <- rio::import("linelist.xlsx", which = "Sheet1")
#
# Stata data file
# linelist_raw <- rio::import("linelist.dat")
#
# For password protected Excel file 
# use the excel.link package 
# library(excel.link)
# linelist_raw <- excel.link::xl.read.file("linelist.xlsx",
#                                          xl.sheet = "Sheet1",
#                                          password = askpass::askpass(prompt = "please enter file
#                                                                      password"))


linelist_raw <- gen_data(dictionary = "Mortality", varnames = "column_name",
                         numcases = 500)


```




```{r read_population_data, warning = FALSE, message = FALSE}

# create fake population by age and sex 
population_data_age <- tibble(age_group = rep.int(c("0-4","5-14","15-29","30-44", "45+"), 2), 
                              sex = rep.int(c("Male", "Female"), 5))
population_data_age$population <- as.integer(runif(nrow(population_data_age), 
                                          min = 500, max = 2000))

```

```{r standardise_clean_data}

study_data_cleaned <- linelist_raw %>%
  # some cleaning
  mutate(age_in_years = as.integer(q155_q5_age_year),
         age_group = age_categories(age_in_years, breakers = c(0, 5, 15, 30, 45)),
         sex = q4_q6_sex,
         died = q136_q34_died == "Yes",
         cause_of_death = factor(q138_q36_died_cause,
                                 levels = c("Malaria/fever", "Diarrhoea", "Respiratory",
                                            "Trauma/accident", "Pregnancy-related", 
                                            "Violence", "Outbreak disease (specify)", 
                                            "Malnutrition", "Unknown", "Other (specify)")), 
         weight_ID = paste0(age_group, "_", sex)) %>%
  filter(!is.na(sex))

```



```{r weights_person_days}

######## WEIGHTING ------------------------------------------------------------
# create a merger ID by age group and sex 
population_data_age <- population_data_age %>% 
  mutate(ID = paste0(age_group, "_", sex))

# get study sample counts 
counts <- study_data_cleaned %>% 
  group_by(age_group, sex) %>% 
  summarise(study = n()) %>% 
  mutate(ID = paste0(age_group, "_", sex)) %>% 
  ungroup() %>% 
  select(ID, study)


# merge counts to population data 
population_data_age <- left_join(population_data_age, 
                                 counts,
                                 by = "ID")

# create weight variable 
population_data_age <- population_data_age %>% 
  mutate(weight = population / study) %>% 
  select(ID, weight)


# merge to study sample 
study_data_cleaned <- left_join(study_data_cleaned, 
                                population_data_age, 
                                by = c("weight_ID" = "ID"))




#### OBSERVATION DAYS ----------------------------------------------------------

## define start and end of your recall period

# set the start of your recall-period
recall_start <- as.Date("2018-01-01")

# set the end of your recall period (when your survey stopped) 
recall_end <- as.Date("2018-05-01")




## define start date 
## this is either the begining of your recall period (which you define in advance)
## or a date after the start of recal if applicable (e.g. arrivals or births)


# choose earliest date entered in survey
# from camp arrival, household arrival and born date
study_data_cleaned <- study_data_cleaned %>% 
  mutate(startdate = pmin(q114_q16_date_arrival_camp, 
                          q41_q25_hh_arrive_date,
                          q88_q33_born_date, na.rm = TRUE))


# find which column had the minimum value 
# (using names and which.min - but cant figure out with dplyr) - have an ugly base R solution


# if start date prior to recall_start then set start to that date (need to fix so it gives dates)
study_data_cleaned$startdate <- ifelse(study_data_cleaned$startdate < recall_start, 
         recall_start, 
         study_data_cleaned$startdate)

#  shorter version of the above
study_data_cleaned <- study_data_cleaned %>% 
  mutate(startdate2 = pmax(pmin(q114_q16_date_arrival_camp, 
                                q41_q25_hh_arrive_date,
                                q88_q33_born_date, na.rm = TRUE),
                           recall_start, na.rm = FALSE))


## define end date 
## this is either the end of your recall period 
## or a date before the end of recall if applicable (e.g. departures, deaths)

# choose earliest date entered in survey
# from camp departures and death 
study_data_cleaned <- study_data_cleaned %>% 
  mutate(enddate = pmin(q45_q29_hh_leave_date, 
                        q137_q35_died_date, na.rm = TRUE)) 


# find which column had the minimum value 
# (using names and which.min - but cant figure out with dplyr) - have an ugly base R solution



# if end date after recall_end then set end to that date (need to fix so it gives dates)
study_data_cleaned$enddate <- ifelse(study_data_cleaned$enddate > recall_end, 
         recall_end, 
         study_data_cleaned$enddate)

# shorter version of the above
study_data_cleaned <- study_data_cleaned %>% 
  mutate(enddate2 = pmin(q45_q29_hh_leave_date, 
                         q137_q35_died_date,
                         recall_end, na.rm = TRUE)) 


## Define observation time in days (need to fix negatives in gen_data)
study_data_cleaned <- study_data_cleaned %>% 
  mutate(obstime = enddate - startdate)

```





# Introduction

# Methods

## Study Design 

## Sample Size and Sampling methods

### Sample Size

### Sampling

#### Random sampling

```{r}
# Insert some code to generate a random number sequence
```

#### Cluster sampling

```{r}
# Insert some example code to do cluster sampling
```

## Data collection

## Data analysis
<!-- TODO: add paragraph about R/sitrep -->

# Results


```{r}
# we first need to create a survery design that reflects the study


## create a var with 1s and 0s as an example (DELETE LATER!!)
study_data_cleaned$binary <- c(1, 0)



# simple random sample (using srvyr package)
survey_design <- study_data_cleaned %>% 
  as_survey_design(ids = 1, # no cluster ids
                   weights = weight # weight variable created above (NULL if want no weights)
                   )

# simple random sample (using survey package) 
suvery_design <- svydesign(
  ids = ~1, # no cluster ids
  weights = ~weight, # weight variable created above (NULL if want no weights)
  data = study_data_cleaned
)


# with a categorical variable 
survey_design %>% 
  group_by(sex) %>% 
  summarize(proportion = survey_mean(vartype = "ci"))

svyciprop(~sex, suvery_design)



# srvyr package
survey_design %>% 
  group_by(binary) %>% 
  summarize(proportion = survey_mean(vartype = "ci"))

# survey package
svyciprop(~binary, suvery_design)



## deaths per 10000 per day with srvyr package
# (artificially ridiculously high!)
survey_design %>% 
  summarise(mortality = survey_ratio(died, obstime, vartype = "ci") * 10000)


```

```{r}
# TODO: Arrivals and departures of included household members during the recall period;
```


## Demographic information

TODO: add some sample text with inline R

Age distribution of current household population by five year age groups, dependency age groups, and by child and adult populations, by gender.
```{r describe_by_age_group_and_sex}
descriptive(study_data_cleaned, 
            "age_group", 
            "sex", 
            rowtotals = TRUE, 
            coltotals = TRUE) %>% 
  rename("Age" = age_group, 
         "Female cases (n)" = Female_n, 
         "%" = Female_prop, 
         "Male cases (n)" = Male_n, 
         "%" = Male_prop) %>% 
  kable(digits = 2)
```

```{r describe_by_age_group_and_sex_wider_age_groups}
study_data_cleaned <- study_data_cleaned %>% 
  mutate(age_group_wide = age_categories(age_in_years, 
                                         breakers = c(0, 1, 5, 15, 60)))

descriptive(study_data_cleaned, "age_group_wide", "sex", rowtotals = TRUE) %>% 
  # rename("Age" = age_group_wide, 
  #        "Female cases (n)" = Female_n, 
  #        "%" = Female_prop, 
  #        "Male cases (n)" = Male_n, 
  #        "%" = Male_prop) %>% 
  setNames(c("Infant, child and adult populations", rep("", nrow(.)))) %>% # find better solution
  kable(digits = 2)
```

Age distribution of current household population by five year age groups and by gender.
```{r age_pyramid}
plot_age_pyramid(study_data_cleaned, 
                 age_group = "age_group", 
                 split_by = "sex") + 
  labs(x = "Cases (n)", y = "Age group (years)") +                    # change axis labels
  theme(legend.position = "bottom", legend.title = element_blank())   # remove title and move legend
```

```{r}
# TODO: Table - Age distribution of the sample population and of the study population.
```


## Mortality

Reported causes of death and cause-specific mortality rates (cause-specific mortality per 10000 still missing!)
```{r}
death_tbl <- function(x) {
  x %>% 
    filter(!is.na(cause_of_death),
           died) %>%  # remove rows with missing outcome
    group_by(cause_of_death) %>% 
    summarise(deaths = n()) %>%  # deaths by cause of death
    # calculate case fatality rate
    do(bind_cols("cause_of_death" = .$cause_of_death, 
                 case_fatality_rate(.$deaths, sum(.$deaths), mergeCI = TRUE))) %>%
    tidyr::complete(cause_of_death, fill = list(deaths = 0)) %>%                 # Ensure all levels are represented
    mutate(cfr = if_else(deaths == 0, "-", paste0(round(cfr, 1), " ", ci))) %>% 
    select(cause_of_death, deaths, cfr) %>% 
    rename("Reported cause of death" = cause_of_death,
           "n" = deaths,
           "% (95% CI)" = cfr)
}
# todo: make cause of death factor!
death_tbl(study_data_cleaned %>% 
  filter(!is.na(cause_of_death),
         died)) %>%
  knitr::kable(digits = 2) 

```

Cause of deaht by age group
```{r}

d1 <- death_tbl(study_data_cleaned %>% 
  filter(!is.na(cause_of_death),
         died,
         age_in_years %in% 0:4)) %>% 
  rename("n <5 years old" = n)
d2 <- death_tbl(study_data_cleaned %>% 
  filter(!is.na(cause_of_death),
         died,
         age_in_years %in% 5:14)) %>% 
  rename("n 5 to 14 years old" = n)
d3 <- death_tbl(study_data_cleaned %>% 
  filter(!is.na(cause_of_death),
         died,
         age_in_years %in% 15:60)) %>% 
  rename("n 15 to 60 years old" = n)
d4 <- death_tbl(study_data_cleaned %>% 
  filter(!is.na(cause_of_death),
         died,
         age_in_years > 60)) %>% 
  rename("n 60+ years old" = n)

cbind(d1, d2[, 2:3], d3[, 2:3], d4[, 2:3]) %>%
  knitr::kable(digits = 2) 


```

Mortality rates and reported causes of death by gender
```{r}
d1 <- death_tbl(study_data_cleaned %>% 
  filter(!is.na(cause_of_death),
         died,
         sex == "Female")) %>% 
  rename("n Female" = n)
d2 <- death_tbl(study_data_cleaned %>% 
  filter(!is.na(cause_of_death),
         died,
         sex == "Male")) %>% 
  rename("n Male" = n)

cbind(d1, d2[, 2:3]) %>%
  knitr::kable(digits = 2) 

```

## Morbidity

```{r}
# symptoms
```

# Conclusions

# Recommendations

# References

